<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parking Booking Dashboard</title>
  <style>
    :root {
      --bg: #eef3f7;
      --panel: #ffffff;
      --panel-soft: #f7fafc;
      --border: #dbe4eb;
      --text: #0b1f33;
      --muted: #5a6f82;
      --accent: #00a6b6;
      --accent-2: #0c5c8e;
      --line: #d7e5ee;
      --success: #2ea66f;
      --warn: #d89a31;
      --danger: #d46277;
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      color: var(--text);
      background:
        radial-gradient(980px 380px at 12% -12%, rgba(0,166,182,.16), transparent 62%),
        radial-gradient(920px 360px at 95% -15%, rgba(12,92,142,.15), transparent 60%),
        var(--bg);
    }

    .app { max-width: 1320px; margin: 28px auto; padding: 0 20px; }

    .header, .panel {
      background: linear-gradient(180deg, #ffffff 0%, var(--panel-soft) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 12px 34px rgba(14,33,53,.08);
    }

    .header {
      padding: 18px 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: "";
      position: absolute;
      inset: 0 0 auto 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      opacity: .85;
    }

    .title { font-weight: 700; letter-spacing: .2px; font-size: 18px; }
    .muted { color: var(--muted); font-size: 13px; }

    .toolbar {
      margin-bottom: 16px;
      padding: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      background: #fff;
    }

    input, select, button {
      background: #fff;
      border: 1px solid #cfdde6;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 13px;
      font-size: 14px;
      transition: border-color .2s ease, box-shadow .2s ease, transform .05s ease;
    }

    input:focus, select:focus, button:focus {
      outline: none;
      border-color: #88bfcc;
      box-shadow: 0 0 0 3px rgba(0,166,182,.12);
    }

    button { cursor: pointer; }
    button:hover { border-color: #9dc7d4; }
    button:active { transform: translateY(1px); }

    .btn-primary {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border: none;
      color: #ffffff;
      font-weight: 700;
      letter-spacing: .2px;
      box-shadow: 0 10px 20px rgba(12,92,142,.24);
    }

    .btn-primary:hover {
      filter: brightness(1.03);
      box-shadow: 0 12px 24px rgba(12,92,142,.28);
    }

    .layout { display: grid; grid-template-columns: minmax(0, 70%) minmax(0, 30%); gap: 16px; }
    .layout > .panel { min-width: 0; min-height: 600px; }
    .panel { padding: 16px; }

    .map-wrap {
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      background: #f4fbff;
      -webkit-overflow-scrolling: touch;
    }

    svg { width: 100%; min-width: 0; display: block; }

    .lot-title { fill: #163451; font-size: 46px; letter-spacing: 2px; font-weight: 400; }
    .spot-rect { fill: rgba(15,91,142,.08); stroke: #b6cfde; stroke-width: 2; rx: 6; }
    .spot-label { fill: #1a3550; font-size: 18px; font-weight: 700; pointer-events: none; }
    .spot-group { cursor: pointer; }
    .spot-group.free .spot-rect { fill: rgba(46,166,111,.11); stroke: rgba(46,166,111,.9); }
    .spot-group.booked .spot-rect { fill: rgba(212,98,119,.12); stroke: rgba(212,98,119,.85); }
    .spot-group.soon .spot-rect { fill: rgba(216,154,49,.13); stroke: rgba(216,154,49,.9); }
    .spot-group.selected .spot-rect { stroke: var(--accent); stroke-width: 3; }

    .chips { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .chip {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d2e2ea;
      color: #365369;
      background: #f9fdff;
      font-weight: 600;
    }

    .kv { margin-top: 10px; display: grid; gap: 8px; font-size: 14px; }
    .map-mini {
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      display: none;
      background: #fff;
    }
    .map-mini-view { height: 340px; background-size: 260%; background-repeat: no-repeat; background-position: center; cursor: grab; touch-action: none; }
    .map-mini-view.dragging { cursor: grabbing; }
    .map-mini-caption { font-size: 12px; color: var(--muted); padding: 6px 8px; border-top: 1px solid var(--line); background: #f8fbfd; }

    .actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; font-size: 13px; background: #fff; border-radius: 10px; overflow: hidden; }
    th, td { padding: 10px; border-bottom: 1px solid #e1ebf1; text-align: left; }
    th { color: #27455f; font-weight: 700; background: #f7fafc; }

    .overlay { position: fixed; inset: 0; background: rgba(5,16,29,.42); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 10; }
    .modal { width: 100%; max-width: 740px; background: #fff; border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 16px 44px rgba(11,31,51,.2); }
    .row { display: grid; gap: 8px; margin-bottom: 10px; }
    .header-actions { display: flex; align-items: center; gap: 8px; }

    .pill {
      font-size: 12px;
      color: #2e4d63;
      border: 1px solid #cbe0ea;
      border-radius: 999px;
      padding: 7px 11px;
      background: #f6fbfe;
      white-space: nowrap;
      font-weight: 600;
    }

    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .admin-block { border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-top: 10px; background: #fff; }
    .users-admin-grid { display:grid; grid-template-columns: 1.1fr .9fr; gap: 12px; margin-top: 8px; }
    .users-left-col, .users-right-col { min-width: 0; }
    .users-right-col { border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: #fbfdff; }
    .list { max-height: 320px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; margin-top: 8px; }
    .list div {
      padding: 8px;
      border-bottom: 1px solid #e2ebf1;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }
    .list div:last-child { border-bottom: 0; }
    .list .item-label {
      min-width: 0;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .list .item-del {
      margin-left: auto;
      flex-shrink: 0;
    }
    .danger { border-color: #d5909d; color: #a03f52; }
    .admin-tab-btn.active { outline: 2px solid #6cbec8; }

    @media (max-width:1040px) {
      .layout { grid-template-columns: 1fr; }
      .grid2 { grid-template-columns: 1fr; }
      .users-admin-grid { grid-template-columns: 1fr; }
      .header { align-items: flex-start; }
      .header-actions { flex-wrap: wrap; }
    }

    @media (max-width:768px) {
      .app { margin: 14px auto; padding: 0 10px; }
      .header { padding: 14px; border-radius: 14px; }
      .title { font-size: 16px; }
      .panel { padding: 12px; }
      .toolbar { padding: 10px; gap: 8px; }
      .toolbar select,
      .toolbar button,
      .toolbar input,
      .toolbar label { width: 100%; }
      .header-actions button { flex: 1 1 calc(50% - 6px); }
      .pill { width: 100%; text-align: center; }

      .map-wrap { border-radius: 10px; overflow: auto; }
      svg { min-width: 840px; }
      .lot-title { font-size: 36px; }
      .spot-label { font-size: 16px; }

      .actions button { width: 100%; }

      table { font-size: 12px; display: block; overflow-x: auto; white-space: nowrap; }
      th, td { padding: 8px; }

      .modal { padding: 12px; }
      .row { margin-bottom: 8px; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div><div class="title">Parking Booking Dashboard</div><div class="muted" id="floorStats">No floor selected</div></div>
    <div class="header-actions">
      <button id="openLoginPanel">Login</button>
      <button id="openAdminPanel" style="display:none">Admin Panel</button>
      <button id="openChangePasswordPanel" style="display:none">Change password</button>
      <button id="logoutBtn" style="display:none">Logout</button>
      <span class="pill" id="currentUserLabel">User: guest</span>
    </div>
  </div>

  <div class="panel toolbar">
    <select id="floorSelect"></select>
    <label class="muted">View date <input id="viewDate" type="date" /></label>
    <label class="muted"><input type="checkbox" id="onlyFree" /> Only free</label>
    <button id="clearFilters">Clear filters</button>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="map-wrap"><svg viewBox="0 0 1240 720"><rect x="0" y="0" width="1240" height="720" fill="#f5f9fc"/><line x1="0" y1="130" x2="1240" y2="130" stroke="#cfe0ea" stroke-width="2" opacity="1"/><text x="1215" y="75" class="lot-title" text-anchor="end">PARKING</text><text x="1215" y="120" class="lot-title" text-anchor="end" id="lotTitleB">FLOOR</text><g id="spotLayer"></g><line x1="0" y1="458" x2="1240" y2="458" stroke="#cfe0ea" stroke-width="2" opacity="1"/></svg></div>
      <div class="chips"><span class="chip">ðŸŸ¢ Free</span><span class="chip">ðŸ”´ Booked</span><span class="chip">ðŸŸ¡ Ending soon</span></div>
    </div>
    <div class="panel">
      <div class="title">Space Details</div><div class="muted" id="spotHint">Select a spot from the map</div>
      <div class="kv" id="details"></div>
      <div class="map-mini" id="mapMini"><div class="map-mini-view" id="mapMiniView"></div><div class="map-mini-caption" id="mapMiniCaption"></div></div>
      <div class="actions" id="actions"></div>
    </div>
  </div>

  <div class="panel" id="bookingsSection" style="margin-top:14px;"><div class="title" id="bookingsTitle">Bookings</div><div class="row" style="max-width:340px; margin-top:8px;"><input id="bookingSearch" placeholder="Search booked by user" /></div><table><thead><tr><th>Floor</th><th>Spot</th><th>User</th><th>Start</th><th>End</th><th>Status</th><th>Created</th></tr></thead><tbody id="bookingRows"></tbody></table><div class="actions" id="bookingPager" style="justify-content:space-between; align-items:center;"></div></div>
</div>

<div class="overlay" id="bootstrapModal"><div class="modal" style="max-width:500px"><h3>First run: create admin password</h3><div class="row"><label class="muted">Admin password</label><input id="bootstrapPassword" type="password" /></div><div class="actions"><button class="btn-primary" id="bootstrapConfirm">Create admin</button></div></div></div>

<div class="overlay" id="loginModal"><div class="modal" style="max-width:500px"><h3>Login</h3><div class="row"><label class="muted">User</label><input id="loginUser" /></div><div class="row"><label class="muted">Password</label><input id="loginPassword" type="password" /></div><div class="actions"><button class="btn-primary" id="loginConfirm">Log in</button><button class="btn-primary" id="loginMicrosoft" style="display:none">Continue with Microsoft</button><button id="loginClose">Close</button></div></div></div>

<div class="overlay" id="changePasswordModal"><div class="modal" style="max-width:500px"><h3>Change password</h3><div class="row"><label class="muted">Old password</label><input id="oldPassword" type="password" /></div><div class="row"><label class="muted">New password</label><input id="newPassword" type="password" /></div><div class="row"><label class="muted">Repeat new password</label><input id="newPasswordRepeat" type="password" /></div><div class="actions"><button class="btn-primary" id="changePasswordConfirm">Save</button><button id="changePasswordClose">Close</button></div></div></div>

<div class="overlay" id="bookingModal"><div class="modal" style="max-width:500px"><h3>Book spot <span id="modalSpot"></span></h3><div class="row"><label class="muted">Booked by user</label><select id="bookUser"></select></div><div class="row"><label class="muted">Start date</label><input id="startAt" type="date"/></div><div class="row" id="endAtRow" style="display:none"><label class="muted">End date</label><input id="endAt" type="date"/></div><div class="row" id="durationRow"><label class="muted">Period</label><select id="durationDays"><option value="1">1 day</option><option value="2">2 days</option><option value="3">3 days</option><option value="4">4 days</option><option value="5">5 days</option></select></div><div class="actions"><button class="btn-primary" id="saveBooking">Confirm booking</button><button id="cancelBooking">Cancel</button></div></div></div>

<div class="overlay" id="releaseModal"><div class="modal" style="max-width:500px"><h3>Release booking</h3><div class="muted" id="releaseBookingInfo" style="margin-bottom:8px"></div><div id="releaseRangeWrap"><div class="row"><label class="muted">Release from</label><input id="releaseFrom" type="date"/></div><div class="row"><label class="muted">Release to</label><input id="releaseTo" type="date"/></div></div><div class="actions"><button class="btn-primary" id="confirmRelease">Confirm release</button><button id="cancelRelease">Cancel</button></div></div></div>

<div class="overlay" id="adminModal"><div class="modal"><h3>Admin Panel</h3>
  <div class="actions" style="margin-top:0; margin-bottom:10px;">
    <button class="admin-tab-btn btn-primary" data-tab="users">Users</button>
    <button class="admin-tab-btn" data-tab="floors">Floors</button>
    <button class="admin-tab-btn" data-tab="spaces">Spaces</button>
    <button class="admin-tab-btn" data-tab="settings">Settings</button>
    <button id="adminClose" style="margin-left:auto">Close</button>
  </div>
  <div id="adminLoading" class="muted" style="display:none; margin-bottom:10px;">Loading admin dataâ€¦</div>

  <div class="admin-tab-pane" id="tab-users">
    <div class="admin-block"><b>Users</b>
      <div class="users-admin-grid">
        <div class="users-left-col">
          <div class="row" style="max-width:340px; margin:0 0 8px;"><input id="userSearch" placeholder="Filter by full name or username" /></div>
          <div class="list" id="usersList"></div>
          <div class="actions"><button id="createNewUserBtn" class="btn-primary">Create new</button></div>
        </div>

        <div class="users-right-col">
          <div class="muted" style="margin-bottom:8px;">Selected user</div>
          <div id="userEditor" style="display:none; margin:0;">
            <div id="userSourceHint" class="muted" style="display:none; margin-bottom:6px;">Loaded from Microsoft account</div>
            <div class="row">
              <input id="newUsername" placeholder="user id"/>
              <input id="newFullName" placeholder="full name"/>
              <input id="newUserPassword" placeholder="password (required for new user)" type="password"/>
              <label class="muted"><input id="newUserAdmin" type="checkbox"/> admin</label>
              <button class="btn-primary" id="createUserBtn">Save user</button>
              <button id="resetUserPwBtn" style="display:none">Reset password</button>
              <button id="deleteUserBtn" class="danger" style="display:none">Delete</button>
              <button id="cancelUserEdit">Cancel</button>
            </div>
          </div>
          <div id="userEditorEmpty" class="muted">Select a user from the list, or click "Create new".</div>
        </div>
      </div>
    </div>
  </div>

  <div class="admin-tab-pane" id="tab-floors" style="display:none">
    <div class="admin-block"><b>Floors</b>
      <div class="users-admin-grid">
        <div class="users-left-col">
          <div class="list" id="floorsList"></div>
          <div class="actions"><button id="createNewFloorBtn" class="btn-primary">Create new</button></div>
        </div>

        <div class="users-right-col">
          <div class="muted" style="margin-bottom:8px;">Selected floor</div>
          <div id="floorEditor" style="display:none; margin-bottom:10px;">
            <div class="row"><input id="floorName" placeholder="floor name"/><input id="floorImageFile" type="file" accept="image/png,image/jpeg,image/webp"/><button class="btn-primary" id="createFloorBtn">Save floor</button><button id="deleteFloorBtn" class="danger" style="display:none">Delete</button><button id="cancelFloorEdit">Cancel</button></div>
            <div id="floorImagePreviewWrap" style="display:none; margin-top:8px;">
              <div class="muted" style="margin-bottom:6px;">Floor image preview</div>
              <div class="map-mini" style="display:block;">
                <div id="floorImagePreview" class="map-mini-view" style="height:340px; background-size:cover; background-position:center;"></div>
              </div>
            </div>
          </div>
          <div id="floorEditorEmpty" class="muted">Select a floor from the list, or click "Create new".</div>
        </div>
      </div>
    </div>
  </div>

  <div class="admin-tab-pane" id="tab-spaces" style="display:none">
    <div class="admin-block"><b>Spaces</b>
      <div class="users-admin-grid">
        <div class="users-left-col">
          <div class="row" style="max-width:320px; margin-bottom:10px;">
            <label class="muted">Floor</label>
            <select id="spaceFloorFilter"></select>
          </div>
          <div class="list" id="spacesList"></div>
          <div class="actions"><button id="createNewSpaceBtn" class="btn-primary">Create new</button></div>
        </div>

        <div class="users-right-col">
          <div class="muted" style="margin-bottom:8px;">Selected space</div>
          <div id="spaceEditor" style="display:none; margin-bottom:10px;">
            <div class="row" style="max-width:420px;">
              <input id="spaceNumber" placeholder="space number"/>
              <div class="actions"><button class="btn-primary" id="createSpaceBtn">Save space</button><button id="deleteSpaceBtn" class="danger" style="display:none">Delete</button><button id="cancelSpaceEdit">Cancel</button></div>
            </div>
            <div class="muted" style="margin:6px 0;">Space map position (drag to set default mini view)</div>
            <div class="map-mini" style="display:block;">
              <div id="spaceMapEditor" class="map-mini-view" style="height:340px;"></div>
            </div>
          </div>
          <div id="spaceEditorEmpty" class="muted">Select a space from the list, or click "Create new".</div>
        </div>
      </div>
    </div>
  </div>

  <div class="admin-tab-pane" id="tab-settings" style="display:none">
    <div class="admin-block"><b>Settings Â· Microsoft SSO</b>
      <div class="row" style="max-width:560px; margin-top:10px;">
        <label class="muted">Tenant ID</label>
        <input id="ssoTenantId" placeholder="common or your tenant id" />
      </div>
      <div class="row" style="max-width:560px;">
        <label class="muted">Client ID</label>
        <input id="ssoClientId" placeholder="Azure App Client ID" />
      </div>
      <div class="row" style="max-width:560px;">
        <label class="muted">Client Secret</label>
        <input id="ssoClientSecret" type="password" placeholder="Leave empty to keep current secret" />
        <span class="muted" id="ssoSecretState">Secret: not set</span>
      </div>
      <div class="row" style="max-width:560px;">
        <label class="muted">Redirect URI</label>
        <input id="ssoRedirectUri" placeholder="http://localhost:3000/api/auth/microsoft/callback" />
      </div>
      <div class="actions" style="margin-bottom:8px;">
        <label class="muted"><input id="ssoEnabled" type="checkbox" /> Enable Microsoft SSO</label>
      </div>
      <div class="actions" style="margin-bottom:8px;">
        <button class="btn-primary" id="saveSsoBtn">Save SSO settings</button>
      </div>
    </div>
  </div>
</div></div>

<div class="overlay" id="messageModal"><div class="modal" style="max-width:460px">
  <h3 id="messageTitle">Message</h3>
  <div id="messageBody" class="muted" style="font-size:14px; line-height:1.5; margin:10px 0 14px;"></div>
  <div class="actions">
    <button id="messageCancel" style="display:none">Cancel</button>
    <button class="btn-primary" id="messageOk">OK</button>
  </div>
</div></div>

<script>
const state = { token:'', me:null, ssoEnabled:false, ssoConfigured:false, floors:[], spaces:[], availability:[], bookings:[], users:[], selectedSpot:null, selectedFloorEditId:null, selectedUserEditId:null, selectedSpaceEditId:null, displayLayouts:{}, spaceMapX:50, spaceMapY:50, spaceMapZoom:260, miniZoom:260, panX:0, panY:0, baseX:50, baseY:50, bookingPage:1, bookingPageSize:25 };
const $ = id => document.getElementById(id);
const fmtDate = d => new Date(`${d}T00:00:00`).toLocaleDateString();
const fmtDateTime = d => d ? new Date(d).toLocaleString() : '-';
const getViewDate = () => $('viewDate').value;
const floor = () => Number($('floorSelect').value || 0);
const esc = (v) => String(v ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

let messageResolver = null;
let messageRejectValue = false;

function closeMessageModal(result) {
  $('messageModal').style.display = 'none';
  if (messageResolver) {
    const r = messageResolver;
    messageResolver = null;
    r(result);
  }
}

function showMessageModal({ title='Message', message='', confirm=false, okText='OK', cancelText='Cancel' } = {}) {
  $('messageTitle').textContent = title;
  $('messageBody').textContent = message;
  $('messageOk').textContent = okText;
  $('messageCancel').textContent = cancelText;
  $('messageCancel').style.display = confirm ? 'inline-block' : 'none';
  $('messageModal').style.display = 'flex';
  return new Promise(resolve => { messageResolver = resolve; });
}

async function uiAlert(message, title='Message') {
  await showMessageModal({ title, message, confirm:false, okText:'OK' });
}

function uiConfirm(message, title='Please confirm') {
  return showMessageModal({ title, message, confirm:true, okText:'Yes', cancelText:'No' });
}

async function api(path, opts={}) {
  const h = { 'Content-Type':'application/json', ...(opts.headers||{}) };
  if (state.token) h.Authorization = `Bearer ${state.token}`;
  const r = await fetch(path, { ...opts, headers: h });
  const j = await r.json().catch(()=>({}));

  if (r.status === 401 && state.token) {
    state.token = '';
    state.me = null;
    state.spaces = [];
    state.bookings = [];
    state.availability = [];
    state.selectedSpot = null;
    setAuthUI();
    await refreshAll().catch(() => {});
    await uiAlert('Your session ended. Please log in again.', 'Logged out');
  }

  if (!r.ok) {
    const base = j.error || `HTTP ${r.status}`;
    const withId = j.errorId ? `${base} (id: ${j.errorId})` : base;
    throw new Error(withId);
  }
  return j;
}

function dateAdd(date, days) {
  const d = new Date(`${date}T00:00:00Z`);
  d.setUTCDate(d.getUTCDate() + days);
  return d.toISOString().slice(0,10);
}

function setAuthUI() {
  $('currentUserLabel').textContent = `User: ${state.me ? (state.me.fullName || state.me.username) : 'guest'}`;
  $('openLoginPanel').style.display = state.me ? 'none' : 'inline-block';
  $('openAdminPanel').style.display = state.me?.isAdmin ? 'inline-block' : 'none';
  $('openChangePasswordPanel').style.display = (state.me && !state.me.authProvider) ? 'inline-block' : 'none';
  $('logoutBtn').style.display = state.me ? 'inline-block' : 'none';
  $('loginMicrosoft').style.display = state.ssoEnabled ? 'inline-block' : 'none';

  const bookingsTitle = $('bookingsTitle');
  if (bookingsTitle) {
    bookingsTitle.textContent = state.me?.isAdmin ? 'Bookings' : (state.me ? 'My bookings' : 'Bookings');
  }

  const bookingsSection = $('bookingsSection');
  if (bookingsSection) {
    bookingsSection.style.display = state.me ? 'block' : 'none';
  }
}

async function refreshSsoStatus() {
  const st = await api('/api/auth/sso/status');
  state.ssoEnabled = !!st.enabled;
  state.ssoConfigured = !!st.configured;
  setAuthUI();
}

async function refreshAll() {
  await refreshSsoStatus();
  state.floors = await api('/api/floors');
  renderFloorSelect();
  if (!floor() && state.floors[0]) $('floorSelect').value = state.floors[0].id;
  await refreshFloorData();
  await refreshBookings();
  render();
}

async function refreshBookings() {
  state.bookings = state.me ? await api('/api/bookings') : [];
  state.bookingPage = 1;
}

async function refreshFloorData() {
  if (!floor()) return;
  state.spaces = await api(`/api/spaces?floorId=${floor()}`);
  state.availability = await api(`/api/availability?floorId=${floor()}&date=${encodeURIComponent(getViewDate())}`);
  if (state.me?.isAdmin) state.users = await api('/api/users');
}

function renderFloorSelect() {
  const v = floor();
  $('floorSelect').innerHTML = state.floors.map(f => `<option value="${f.id}">${esc(f.name)}</option>`).join('') || '<option value="">No floors</option>';
  if (v) $('floorSelect').value = String(v);
}

function currentFloorObj() { return state.floors.find(f => f.id === floor()); }
function spotAt() { return state.availability.find(s => s.id === state.selectedSpot); }

function statusClass(s) {
  if (!s?.isBooked) return 'free';
  // For guests or users without permission, booking end may be hidden.
  // In that case keep generic booked state instead of incorrectly showing "ending soon".
  if (!s.bookingEnd) return 'booked';
  const view = new Date(`${getViewDate()}T12:00:00`).getTime();
  const end = new Date(`${s.bookingEnd}T23:59:59`).getTime();
  const hoursLeft = (end - view) / 3600000;
  return (hoursLeft >= 0 && hoursLeft <= 24) ? 'soon' : 'booked';
}

function renderMap() {
  const layer = $('spotLayer'); layer.innerHTML = '';
  const onlyFree = $('onlyFree').checked;
  const toSortable = (v) => {
    const s = String(v ?? '').trim();
    if (/^\d+$/.test(s)) return { num: Number(s), raw: s };
    return { num: Number.POSITIVE_INFINITY, raw: s.toLowerCase() };
  };
  const orderedSpaces = [...state.availability].sort((a, b) => {
    const sa = toSortable(a.space_number);
    const sb = toSortable(b.space_number);
    if (sa.num !== sb.num) return sa.num - sb.num;
    return sa.raw.localeCompare(sb.raw);
  });

  const buildDynamicLayouts = (items) => {
    const svgW = 1240;
    const gapX = 12;
    const gapY = 14;
    const topBand = { start: 160, end: 438 };
    const bottomBand = { start: 485, end: 690 };

    const count = items.length;
    if (!count) return {};

    // Keep visual balance: prefer 1 row (small sets), then 2 rows (top+bottom),
    // then grow in pairs (2 rows per band) only when really needed.
    let rowsNeeded = 1;
    if (count > 13) rowsNeeded = 2;
    if (count > 36) rowsNeeded = 4;

    const rowsTop = Math.ceil(rowsNeeded / 2);
    const rowsBottom = Math.floor(rowsNeeded / 2);

    const colsPerRow = Math.ceil(count / rowsNeeded);

    const topHeight = topBand.end - topBand.start;
    const bottomHeight = bottomBand.end - bottomBand.start;
    const hTop = (topHeight - gapY * Math.max(0, rowsTop - 1)) / rowsTop;
    const hBottom = rowsBottom > 0 ? (bottomHeight - gapY * Math.max(0, rowsBottom - 1)) / rowsBottom : hTop;

    let slotH = Math.min(170, hTop, hBottom);
    let slotW = Math.min(70, slotH * 0.42, (svgW - 36 - gapX * Math.max(0, colsPerRow - 1)) / colsPerRow);

    slotH = Math.max(92, slotH);
    slotW = Math.max(38, slotW);

    const rows = [];
    for (let i = 0; i < rowsTop; i++) rows.push({ inTop: true, idxInBand: i, count: 0 });
    for (let i = 0; i < rowsBottom; i++) rows.push({ inTop: false, idxInBand: i, count: 0 });

    // Even distribution to avoid one short "orphan" row in the middle.
    const base = Math.floor(count / rows.length);
    let rem = count % rows.length;
    rows.forEach((r) => {
      r.count = base + (rem > 0 ? 1 : 0);
      if (rem > 0) rem--;
    });

    const layouts = {};
    let itemIdx = 0;

    const bandOffset = (bandHeight, rowsInBand) => {
      const used = rowsInBand * slotH + Math.max(0, rowsInBand - 1) * gapY;
      return Math.max(0, (bandHeight - used) / 2);
    };

    const topOffset = bandOffset(topHeight, rowsTop);
    const bottomOffset = rowsBottom > 0 ? bandOffset(bottomHeight, rowsBottom) : 0;

    rows.forEach((row) => {
      const band = row.inTop ? topBand : bottomBand;
      const yOffset = row.inTop ? topOffset : bottomOffset;
      const y = band.start + yOffset + row.idxInBand * (slotH + gapY);

      const rowWidth = row.count * slotW + Math.max(0, row.count - 1) * gapX;
      const startX = (svgW - rowWidth) / 2;

      for (let c = 0; c < row.count; c++) {
        const s = items[itemIdx++];
        if (!s) break;
        layouts[s.id] = { x: startX + c * (slotW + gapX), y, w: slotW, h: slotH };
      }
    });

    return layouts;
  };

  state.displayLayouts = buildDynamicLayouts(orderedSpaces);

  for (const s of orderedSpaces) {
    if (onlyFree && s.isBooked) continue;
    const d = state.displayLayouts[s.id] || { x: s.x ?? 20, y: s.y ?? 160, w: s.w ?? 72, h: s.h ?? 170 };
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('class', `spot-group ${statusClass(s)} ${state.selectedSpot===s.id?'selected':''}`);
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('class','spot-rect'); rect.setAttribute('x', d.x); rect.setAttribute('y', d.y); rect.setAttribute('width', d.w); rect.setAttribute('height', d.h);
    const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
    txt.setAttribute('class','spot-label'); txt.setAttribute('x', d.x + d.w / 2); txt.setAttribute('y', d.y + d.h / 2); txt.setAttribute('text-anchor','middle'); txt.setAttribute('dominant-baseline','middle'); txt.setAttribute('font-size', String(Math.max(12, Math.min(22, d.w * 0.32)))); txt.textContent=s.space_number;
    const isOwnBooking = Number(s.bookingOwnerId) === Number(state.me?.userId);
    const blockedForViewer = !!s.isBooked && (!state.me || (!state.me?.isAdmin && !isOwnBooking));
    g.append(rect,txt);
    if (!blockedForViewer) {
      g.onclick = ()=>{ state.selectedSpot=s.id; render(); };
    } else {
      g.style.cursor = 'not-allowed';
    }
    layer.appendChild(g);
  }
}

function renderDetails() {
  $('actions').innerHTML=''; $('details').innerHTML=''; $('mapMini').style.display='none';
  const s = spotAt();
  if (!s) { $('spotHint').textContent = 'Select a spot from the map'; return; }
  const f = currentFloorObj();
  $('spotHint').textContent = `${f?.name || ''} Â· Spot ${s.space_number}`;
  const canSeeBookingDetails = !!state.me && (state.me?.isAdmin || s.bookingOwnerId === state.me?.userId);
  $('details').innerHTML = `<div><b>Status:</b> ${s.isBooked?'Booked':'Free'}</div>${s.isBooked && canSeeBookingDetails?`<div><b>User:</b> ${esc(s.bookingUser)}</div><div><b>Start:</b> ${esc(fmtDate(s.bookingStart))}</div><div><b>End:</b> ${esc(fmtDate(s.bookingEnd))}</div>`:''}`;

  const map = $('mapMiniView');
  map.style.backgroundImage = f?.image_path ? `url(${f.image_path})` : 'none';
  const d = state.displayLayouts[s.id] || { x: s.x ?? 20, y: s.y ?? 160, w: s.w ?? 72, h: s.h ?? 170 };
  state.baseX = s.map_x ?? (((d.x) + (d.w)/2)/1240)*100;
  state.baseY = s.map_y ?? (((d.y) + (d.h)/2)/720)*100;
  state.panX = 0; state.panY = 0;
  state.miniZoom = s.map_zoom ?? 260;
  updateMiniPos();
  $('mapMini').style.display='block'; $('mapMiniCaption').textContent = `Location on ${f?.name || 'floor'} (drag to explore)`;

  if (state.me && !s.isBooked) {
    const b = document.createElement('button'); b.className='btn-primary'; b.textContent='Book this spot'; b.onclick=openBookingModal; $('actions').appendChild(b);
  }
  if (state.me && s.isBooked && (state.me?.isAdmin || s.bookingOwnerId===state.me?.userId)) {
    const r = document.createElement('button'); r.textContent='Release'; r.onclick=openReleaseModal; $('actions').appendChild(r);
  }
}

async function openBookingFromList(spaceId, startDate, endDate, floorId) {
  if (!state.me) return;

  if (Number(floorId) && Number($('floorSelect').value) !== Number(floorId)) {
    $('floorSelect').value = String(floorId);
    await refreshFloorData();
  }

  // Keep current view date unchanged to avoid confusing historical color states
  // when clicking completed/old bookings in the list.
  state.selectedSpot = Number(spaceId);
  render();
}

function renderTable() {
  const today = new Date().toISOString().slice(0,10);
  const search = $('bookingSearch').value.trim().toLowerCase();
  const bookingStatus = (b) => {
    if (today < b.start_date) return 'Upcoming';
    if (today > b.end_date) return 'Completed';
    return 'Active';
  };

  const filteredRows = state.bookings.filter(b => {
    if (!search) return true;
    const st = bookingStatus(b).toLowerCase();
    const haystack = [
      String(b.floor_name || ''),
      String(b.space_number || ''),
      String(b.full_name || ''),
      String(b.username || ''),
      String(b.start_date || ''),
      String(b.end_date || ''),
      String(b.created_at || ''),
      fmtDate(b.start_date || ''),
      fmtDate(b.end_date || ''),
      fmtDateTime(b.created_at || ''),
      st
    ].join(' ').toLowerCase();
    return haystack.includes(search);
  }).sort((a, b) => {
    const ta = new Date(a.created_at || 0).getTime();
    const tb = new Date(b.created_at || 0).getTime();
    return tb - ta;
  });

  const total = filteredRows.length;
  const pageSize = state.bookingPageSize || 25;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  state.bookingPage = Math.min(Math.max(1, state.bookingPage), totalPages);
  const start = (state.bookingPage - 1) * pageSize;
  const rows = filteredRows.slice(start, start + pageSize);

  $('bookingRows').innerHTML = rows.map(b => {
    const st = bookingStatus(b);
    const clickable = !!state.me;
    return `<tr ${clickable ? `onclick="openBookingFromList(${b.space_id}, '${b.start_date}', '${b.end_date}', ${b.floor_id})" style="cursor:pointer;"` : ''}><td>${esc(b.floor_name || '-')}</td><td>${esc(b.space_number)}</td><td>${esc(b.full_name || b.username)}</td><td>${esc(fmtDate(b.start_date))}</td><td>${esc(fmtDate(b.end_date))}</td><td>${esc(st)}</td><td>${esc(fmtDateTime(b.created_at))}</td></tr>`;
  }).join('') || '<tr><td colspan="7" class="muted">No bookings</td></tr>';

  const pager = $('bookingPager');
  if (!pager) return;
  if (!total) {
    pager.innerHTML = '';
    return;
  }

  pager.innerHTML = `
    <span class="muted">Showing ${start + 1}-${Math.min(start + pageSize, total)} of ${total}</span>
    <div style="display:flex; gap:8px;">
      <button id="bookingPrevPage" ${state.bookingPage <= 1 ? 'disabled' : ''}>Previous</button>
      <button id="bookingNextPage" ${state.bookingPage >= totalPages ? 'disabled' : ''}>Next</button>
    </div>
  `;

  $('bookingPrevPage')?.addEventListener('click', () => {
    if (state.bookingPage > 1) {
      state.bookingPage -= 1;
      renderTable();
    }
  });

  $('bookingNextPage')?.addEventListener('click', () => {
    if (state.bookingPage < totalPages) {
      state.bookingPage += 1;
      renderTable();
    }
  });
}

function render() {
  const f = currentFloorObj();
  $('floorStats').textContent = f ? `${f.name} Â· ${state.spaces.length} spaces` : 'No floor selected';
  const floorTitle = f ? f.name.toUpperCase() : 'FLOOR';
  $('lotTitleB').textContent = floorTitle;
  const dynamicSize = floorTitle.length > 18 ? 36 : floorTitle.length > 12 ? 42 : 46;
  $('lotTitleB').setAttribute('font-size', String(dynamicSize));
  renderMap(); renderDetails(); renderTable();
}

function updateMiniPos(zoom=state.miniZoom || 260) {
  const map = $('mapMiniView');
  const x = Math.max(0,Math.min(100,state.baseX + state.panX));
  const y = Math.max(0,Math.min(100,state.baseY + state.panY));
  state.miniZoom = Math.max(100, Math.min(500, zoom));
  map.style.backgroundPosition = `${x}% ${y}%`;
  map.style.backgroundSize = `${state.miniZoom}%`;
}

async function openBookingModal() {
  const s = spotAt(); if (!s) return;
  $('modalSpot').textContent = s.space_number;
  $('startAt').value = getViewDate();
  $('endAt').value = getViewDate();
  $('durationDays').value = '1';
  if (state.me?.isAdmin) {
    $('endAtRow').style.display = 'grid';
    $('durationRow').style.display = 'none';
    if (!state.users.length) state.users = await api('/api/users');
    $('bookUser').innerHTML = state.users.map(u=>`<option value="${u.id}">${esc(u.fullName || u.username)}</option>`).join('');
  } else {
    $('endAtRow').style.display = 'none';
    $('durationRow').style.display = 'grid';
    $('bookUser').innerHTML = `<option value="${state.me.userId}">${esc(state.me.fullName || state.me.username)}</option>`;
  }
  $('bookingModal').style.display='flex';
}

async function saveBooking() {
  const s = spotAt(); if (!s) return;
  const start = $('startAt').value;
  let end = $('endAt').value;
  if (state.me?.isAdmin) {
    if (!start || !end) return uiAlert('Select start and end dates');
    if (start > end) return uiAlert('End date must be same or after start date');
  } else {
    const days = Number($('durationDays').value || 1);
    if (!start) return uiAlert('Select start date');
    end = dateAdd(start, Math.max(0, Math.min(5, days) - 1));
  }

  const payload = { floorId: floor(), spaceId: s.id, startDate:start, endDate:end };
  if (state.me?.isAdmin) payload.userId = Number($('bookUser').value);
  try { await api('/api/bookings', { method:'POST', body: JSON.stringify(payload) }); $('bookingModal').style.display='none'; await refreshFloorData(); await refreshBookings(); render(); }
  catch (e) { uiAlert(e.message); }
}

function openReleaseModal() {
  const s = spotAt();
  if (!s || !s.isBooked) return;
  const oneDay = s.bookingStart === s.bookingEnd;
  $('releaseBookingInfo').textContent = `Booking: ${fmtDate(s.bookingStart)} - ${fmtDate(s.bookingEnd)}${oneDay ? ' (1 day)' : ''}`;
  $('releaseFrom').value = s.bookingStart || getViewDate();
  $('releaseTo').value = s.bookingEnd || getViewDate();
  $('releaseRangeWrap').style.display = oneDay ? 'none' : 'block';
  $('releaseModal').style.display = 'flex';
}

async function releaseBooking() {
  const s = spotAt(); if (!s) return;
  try {
    const oneDay = s.bookingStart === s.bookingEnd;
    const payload = {
      spaceId: s.id,
      date: getViewDate(),
      userId: state.me?.isAdmin ? s.bookingOwnerId : undefined
    };
    if (!oneDay) {
      payload.releaseStart = $('releaseFrom').value;
      payload.releaseEnd = $('releaseTo').value;
    }

    await api('/api/bookings/release', { method:'POST', body: JSON.stringify(payload)});
    $('releaseModal').style.display = 'none';
    await refreshFloorData();
    await refreshBookings();
    render();
  } catch (e) { uiAlert(e.message); }
}

async function changePassword() {
  const oldPassword = $('oldPassword').value;
  const newPassword = $('newPassword').value;
  const newPasswordRepeat = $('newPasswordRepeat').value;
  if (!oldPassword || !newPassword || !newPasswordRepeat) return uiAlert('Please fill all password fields');
  if (newPassword.length < 4) return uiAlert('New password must be at least 4 characters');
  if (newPassword !== newPasswordRepeat) return uiAlert('New passwords do not match');
  try {
    await api('/api/me/change-password', { method:'POST', body: JSON.stringify({ oldPassword, newPassword }) });
    $('oldPassword').value = '';
    $('newPassword').value = '';
    $('newPasswordRepeat').value = '';
    $('changePasswordModal').style.display = 'none';
    await uiAlert('Password changed successfully', 'Success');
  } catch (e) {
    uiAlert(e.message);
  }
}

function setLoginLoading(on) {
  const modal = $('loginModal')?.querySelector('.modal');
  if (modal) {
    modal.style.opacity = on ? '0.55' : '1';
    modal.style.filter = on ? 'grayscale(0.35)' : 'none';
  }
  $('loginUser').disabled = !!on;
  $('loginPassword').disabled = !!on;
  $('loginConfirm').disabled = !!on;
  $('loginMicrosoft').disabled = !!on;
  $('loginClose').disabled = !!on;
}

function startMicrosoftLogin() {
  setLoginLoading(true);
  window.location.href = '/api/auth/microsoft/start';
}

async function doLogin() {
  setLoginLoading(true);
  try {
    const out = await api('/api/login', { method:'POST', body: JSON.stringify({ username: $('loginUser').value.trim(), password: $('loginPassword').value })});
    state.token = out.token; state.me = { ...out.user, userId: out.user.id };
    $('loginModal').style.display='none'; setAuthUI(); await refreshAll();
  } catch (e) { uiAlert(e.message); }
  finally { setLoginLoading(false); }
}

async function checkBootstrap() {
  const health = await api('/api/health');
  if (health.needsBootstrap) $('bootstrapModal').style.display='flex';
}

async function createAdmin() {
  try { await api('/api/bootstrap', { method:'POST', body: JSON.stringify({ adminPassword: $('bootstrapPassword').value })}); $('bootstrapModal').style.display='none'; uiAlert('Admin created. Login as admin.'); $('loginModal').style.display='flex'; }
  catch (e) { uiAlert(e.message); }
}

function openUserEditor(isEdit = false) {
  $('userEditor').style.display = 'block';
  $('userEditorEmpty').style.display = 'none';
  $('createUserBtn').textContent = isEdit ? 'Save user' : 'Create user';
  $('newUsername').disabled = isEdit;
  $('newUserPassword').style.display = isEdit ? 'none' : 'inline-block';
  $('newUserPassword').placeholder = isEdit ? 'password change via reset button' : 'password (required for new user)';
  $('resetUserPwBtn').style.display = isEdit ? 'inline-block' : 'none';
  $('deleteUserBtn').style.display = isEdit ? 'inline-block' : 'none';
  $('userSourceHint').style.display = 'none';
}

function closeUserEditor() {
  state.selectedUserEditId = null;
  $('userEditor').style.display = 'none';
  $('userEditorEmpty').style.display = 'block';
  $('newUsername').value = '';
  $('newUserPassword').value = '';
  $('newFullName').value = '';
  $('newUserAdmin').checked = false;
  $('newUsername').disabled = false;
  $('newUserAdmin').disabled = false;
  $('createUserBtn').disabled = false;
  $('resetUserPwBtn').style.display = 'none';
  $('deleteUserBtn').style.display = 'none';
  $('userSourceHint').style.display = 'none';
}

function openFloorEditor(isEdit = false) {
  $('floorEditor').style.display = 'block';
  $('floorEditorEmpty').style.display = 'none';
  $('createFloorBtn').textContent = isEdit ? 'Save floor' : 'Create floor';
  $('deleteFloorBtn').style.display = isEdit ? 'inline-block' : 'none';
}

function closeFloorEditor() {
  state.selectedFloorEditId = null;
  $('floorEditor').style.display = 'none';
  $('floorEditorEmpty').style.display = 'block';
  $('floorName').value = '';
  $('floorImageFile').value = '';
  $('deleteFloorBtn').style.display = 'none';
  setFloorImagePreview('');
}

function switchAdminTab(tabName) {
  const tabs = ['users', 'floors', 'spaces', 'settings'];
  tabs.forEach(name => {
    const pane = $(`tab-${name}`);
    if (pane) pane.style.display = name === tabName ? 'block' : 'none';
  });
  document.querySelectorAll('.admin-tab-btn').forEach(btn => {
    const active = btn.dataset.tab === tabName;
    btn.classList.toggle('active', active);
    btn.classList.toggle('btn-primary', active);
  });
  if (tabName === 'floors') closeFloorEditor();
  if (tabName === 'users') closeUserEditor();
  if (tabName === 'spaces') {
    closeSpaceEditor();
    loadSpacesList();
  }
}

async function loadAdminLists() {
  $('adminLoading').style.display = 'block';
  try {
    const sso = await api('/api/admin/sso');
    state.ssoEnabled = !!sso.enabled;
    state.ssoConfigured = !!sso.configured;
    $('ssoTenantId').value = sso.tenantId || 'common';
    $('ssoClientId').value = sso.clientId || '';
    $('ssoRedirectUri').value = sso.redirectUri || '';
    $('ssoEnabled').checked = !!sso.enabled;
    $('ssoSecretState').textContent = sso.hasClientSecret ? 'Secret: set' : 'Secret: not set';
    $('ssoClientSecret').value = '';

    state.users = await api('/api/users');
    const floors = await api('/api/floors');
    state.floors = floors;
    renderUsersList();
    $('floorsList').innerHTML = floors.map(f => `<div onclick="selectFloorForEdit(${f.id})" style="cursor:pointer;${(state.selectedFloorEditId===f.id && $('floorEditor').style.display !== 'none')?'background:#e8f4f8;':''}"><span class="item-label">${esc(f.name)}</span></div>`).join('') || '<div>No floors</div>';

    const current = Number($('spaceFloorFilter').value || 0);
    $('spaceFloorFilter').innerHTML = floors.map(f => `<option value="${f.id}">${esc(f.name)}</option>`).join('') || '<option value="">No floors</option>';
    if (current && floors.some(f => f.id === current)) $('spaceFloorFilter').value = String(current);
    if (!$('spaceFloorFilter').value && floors[0]) $('spaceFloorFilter').value = String(floors[0].id);
    await loadSpacesList();
  } finally {
    $('adminLoading').style.display = 'none';
  }
}

function renderUsersList() {
  const q = ($('userSearch')?.value || '').trim().toLowerCase();
  const filtered = state.users.filter(u => {
    if (!q) return true;
    const fullName = String(u.fullName || '').toLowerCase();
    const username = String(u.username || '').toLowerCase();
    return fullName.includes(q) || username.includes(q);
  }).sort((a, b) => {
    const rank = (u) => u.isBuiltinAdmin ? 0 : (u.isAdmin ? 1 : 2);
    const ra = rank(a);
    const rb = rank(b);
    if (ra !== rb) return ra - rb;
    const na = String(a.fullName || a.username || '').toLowerCase();
    const nb = String(b.fullName || b.username || '').toLowerCase();
    if (na !== nb) return na.localeCompare(nb);
    return String(a.username || '').toLowerCase().localeCompare(String(b.username || '').toLowerCase());
  });

  $('usersList').innerHTML = filtered.map((u) => {
    const label = u.isBuiltinAdmin
      ? 'admin'
      : `${u.fullName || u.username} <span class=\"muted\">(${u.username})</span>`;
    return `<div onclick="selectUserForEdit(${u.id})" style="cursor:pointer;${state.selectedUserEditId===u.id?'background:#e8f4f8;':''}"><span class="item-label">${label}</span></div>`;
  }).join('') || '<div>No users</div>';
}

function selectUserForEdit(id) {
  const u = state.users.find(x => x.id === id);
  if (!u) return;
  state.selectedUserEditId = id;
  openUserEditor(true);
  $('newUsername').value = u.username || '';
  $('newFullName').value = u.fullName || u.username || '';
  $('newUserPassword').value = '';
  $('newUserAdmin').checked = !!u.isAdmin;
  if (u.isBuiltinAdmin) {
    $('newUsername').disabled = true;
    $('newFullName').disabled = true;
    $('newUserAdmin').disabled = true;
    $('createUserBtn').disabled = true;
    $('createUserBtn').style.display = 'none';
    $('deleteUserBtn').style.display = 'none';
    $('resetUserPwBtn').style.display = 'inline-block';
  } else {
    $('newUsername').disabled = true;
    $('newFullName').disabled = false;
    $('newUserAdmin').disabled = false;
    $('createUserBtn').disabled = false;
    $('createUserBtn').style.display = 'inline-block';
    $('deleteUserBtn').style.display = 'inline-block';
    $('resetUserPwBtn').style.display = u.authProvider ? 'none' : 'inline-block';
  }
  $('userSourceHint').style.display = u.authProvider === 'microsoft' ? 'block' : 'none';
  loadAdminLists();
}

async function resetPw(id) { try { const r=await api(`/api/users/${id}/reset-password`, { method:'POST' }); await uiAlert(`Temporary password: ${r.temporaryPassword}`, 'Password reset'); } catch(e){uiAlert(e.message);} }
async function delUser(id) { if (!(await uiConfirm('Delete user?', 'Delete user'))) return; try { await api(`/api/users/${id}`, { method:'DELETE' }); if (state.selectedUserEditId===id) closeUserEditor(); await loadAdminLists(); } catch(e){uiAlert(e.message);} }
async function delFloor(id) { if (!(await uiConfirm('Delete floor?', 'Delete floor'))) return; try { await api(`/api/floors/${id}`, { method:'DELETE' }); if (state.selectedFloorEditId===id) closeFloorEditor(); await loadAdminLists(); await refreshAll(); } catch(e){uiAlert(e.message);} }

function selectFloorForEdit(id) {
  const f = state.floors.find(x => x.id === id);
  if (!f) return;
  state.selectedFloorEditId = id;
  openFloorEditor(true);
  $('floorName').value = f.name || '';
  $('floorImageFile').value = '';
  setFloorImagePreview(f.image_path || '');
  loadAdminLists();
}

window.resetPw = resetPw; window.delUser = delUser; window.delFloor = delFloor; window.selectFloorForEdit = selectFloorForEdit; window.selectUserForEdit = selectUserForEdit; window.selectSpaceForEdit = selectSpaceForEdit; window.delSpace = delSpace; window.openBookingFromList = openBookingFromList;

async function saveSsoSettings() {
  try {
    const payload = {
      tenantId: $('ssoTenantId').value.trim() || 'common',
      clientId: $('ssoClientId').value.trim(),
      redirectUri: $('ssoRedirectUri').value.trim(),
      enabled: $('ssoEnabled').checked
    };
    const secret = $('ssoClientSecret').value;
    if (secret) payload.clientSecret = secret;

    await api('/api/admin/sso', { method:'POST', body: JSON.stringify(payload) });
    await loadAdminLists();
    await refreshSsoStatus();
    await uiAlert('SSO settings saved', 'Settings');
  } catch (e) { uiAlert(e.message); }
}

async function createUser() {
  try {
    const username = $('newUsername').value.trim();
    const fullName = $('newFullName').value.trim();
    const password = $('newUserPassword').value;
    const isAdmin = $('newUserAdmin').checked;

    if (state.selectedUserEditId) {
      await api(`/api/users/${state.selectedUserEditId}`, { method:'PATCH', body: JSON.stringify({ isAdmin, fullName }) });
      closeUserEditor();
    } else {
      if (!username || !password) return uiAlert('User ID and password are required');
      if (password.length < 4) return uiAlert('Password must be at least 4 characters');
      if (!fullName) return uiAlert('Full name is required');
      await api('/api/users', { method:'POST', body: JSON.stringify({ username, fullName, password, isAdmin }) });
      closeUserEditor();
    }
    await loadAdminLists();
  } catch(e){uiAlert(e.message);} }

async function fileToDataUrl(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ''));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function setFloorImagePreview(src) {
  const wrap = $('floorImagePreviewWrap');
  const preview = $('floorImagePreview');
  if (!src) {
    wrap.style.display = 'none';
    preview.style.backgroundImage = '';
    return;
  }
  preview.style.backgroundImage = `url(${src})`;
  wrap.style.display = 'block';
}

async function createFloor() {
  try {
    const name = $('floorName').value.trim();
    if (!name) return uiAlert('Floor name is required');
    const file = $('floorImageFile').files?.[0];
    const payload = { name };
    if (file) {
      payload.imageData = await fileToDataUrl(file);
      payload.imageName = file.name;
    }

    if (state.selectedFloorEditId) {
      await api(`/api/floors/${state.selectedFloorEditId}`, { method:'PATCH', body: JSON.stringify(payload) });
    } else {
      await api('/api/floors', { method:'POST', body: JSON.stringify(payload) });
    }

    closeFloorEditor();
    await loadAdminLists();
    await refreshAll();
  } catch(e){ uiAlert(e.message); }
}

function openSpaceEditor(isEdit = false) {
  $('spaceEditor').style.display = 'block';
  $('spaceEditorEmpty').style.display = 'none';
  $('createSpaceBtn').textContent = isEdit ? 'Save space' : 'Create space';
  $('deleteSpaceBtn').style.display = isEdit ? 'inline-block' : 'none';
}

function closeSpaceEditor() {
  state.selectedSpaceEditId = null;
  $('spaceEditor').style.display = 'none';
  $('spaceEditorEmpty').style.display = 'block';
  $('spaceNumber').value = '';
  state.spaceMapX = 50;
  state.spaceMapY = 50;
  state.spaceMapZoom = 260;
  $('deleteSpaceBtn').style.display = 'none';
  renderSpaceMapEditor();
}

function currentSpaceFloor() {
  return state.floors.find(f => f.id === Number($('spaceFloorFilter').value));
}

function renderSpaceMapEditor() {
  const el = $('spaceMapEditor');
  const f = currentSpaceFloor();
  el.style.backgroundImage = f?.image_path ? `url(${f.image_path})` : 'none';
  el.style.backgroundSize = `${state.spaceMapZoom}%`;
  el.style.backgroundPosition = `${Math.max(0, Math.min(100, state.spaceMapX))}% ${Math.max(0, Math.min(100, state.spaceMapY))}%`;
}

async function loadSpacesList() {
  const floorId = Number($('spaceFloorFilter').value || 0);
  if (!floorId) {
    $('spacesList').innerHTML = '<div>No floor selected</div>';
    return;
  }
  const spaces = await api(`/api/spaces?floorId=${floorId}`);
  state.spaces = spaces;
  $('spacesList').innerHTML = spaces.map(s => `<div onclick="selectSpaceForEdit(${s.id})" style="cursor:pointer;${state.selectedSpaceEditId===s.id?'background:#e8f4f8;':''}"><span class="item-label">${esc(s.space_number)}</span></div>`).join('') || '<div>No spaces</div>';
  renderSpaceMapEditor();
}

function selectSpaceForEdit(id) {
  const s = state.spaces.find(x => x.id === id);
  if (!s) return;
  state.selectedSpaceEditId = id;
  openSpaceEditor(true);
  $('spaceNumber').value = s.space_number || '';
  state.spaceMapX = s.map_x ?? 50;
  state.spaceMapY = s.map_y ?? 50;
  // Restore saved zoom for this space in editor (same value used later in booking preview).
  state.spaceMapZoom = s.map_zoom ?? 260;
  renderSpaceMapEditor();
  // Avoid reloading list on each click; keep selection responsive after save/edit.
  $('spacesList').innerHTML = state.spaces.map(x => `<div onclick="selectSpaceForEdit(${x.id})" style="cursor:pointer;${state.selectedSpaceEditId===x.id?'background:#e8f4f8;':''}"><span class="item-label">${esc(x.space_number)}</span></div>`).join('') || '<div>No spaces</div>';
}

async function delSpace(id) {
  if (!(await uiConfirm('Delete space?', 'Delete space'))) return;
  try {
    await api(`/api/spaces/${id}`, { method:'DELETE' });
    if (state.selectedSpaceEditId === id) closeSpaceEditor();
    await loadSpacesList();
    await refreshFloorData();
    render();
  } catch(e){ uiAlert(e.message); }
}

async function createSpace() {
  try {
    const floorId = Number($('spaceFloorFilter').value || 0);
    const spaceNumber = $('spaceNumber').value.trim();
    if (!floorId) return uiAlert('Select floor first');
    if (!spaceNumber) return uiAlert('Space number is required');

    const payload = { floorId, spaceNumber, mapX: state.spaceMapX, mapY: state.spaceMapY, mapZoom: state.spaceMapZoom };
    if (state.selectedSpaceEditId) {
      await api(`/api/spaces/${state.selectedSpaceEditId}`, { method:'PATCH', body: JSON.stringify(payload) });
    } else {
      await api('/api/spaces', { method:'POST', body: JSON.stringify(payload) });
    }

    closeSpaceEditor();
    await loadSpacesList();
    await refreshFloorData();
    render();
  } catch(e){uiAlert(e.message);} }

(function init(){
  const d = new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); $('viewDate').value = d.toISOString().slice(0,10);

  $('openLoginPanel').onclick = ()=> { setLoginLoading(false); $('loginModal').style.display='flex'; }; $('loginClose').onclick = ()=> { setLoginLoading(false); $('loginModal').style.display='none'; }; $('loginConfirm').onclick = doLogin; $('loginMicrosoft').onclick = startMicrosoftLogin;
  $('openChangePasswordPanel').onclick = ()=> $('changePasswordModal').style.display='flex';
  $('changePasswordClose').onclick = ()=> $('changePasswordModal').style.display='none';
  $('changePasswordConfirm').onclick = changePassword;
  ['oldPassword','newPassword','newPasswordRepeat'].forEach(id => $(id).addEventListener('keydown', (e) => { if (e.key === 'Enter') changePassword(); }));
  $('messageOk').onclick = () => closeMessageModal(true);
  $('messageCancel').onclick = () => closeMessageModal(false);
  ['loginUser','loginPassword'].forEach(id => $(id).addEventListener('keydown', (e) => {
    if (e.key === 'Enter') doLogin();
  }));
  $('logoutBtn').onclick = async ()=>{ state.token=''; state.me=null; state.spaces=[]; state.bookings=[]; state.availability=[]; state.selectedSpot=null; setAuthUI(); await refreshAll(); };
  $('bootstrapConfirm').onclick = createAdmin;
  $('bootstrapPassword').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') createAdmin();
  });
  $('openAdminPanel').onclick = async ()=>{ $('adminModal').style.display='flex'; switchAdminTab('users'); await loadAdminLists(); };
  document.querySelectorAll('.admin-tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchAdminTab(btn.dataset.tab));
  });
  $('adminClose').onclick = ()=> $('adminModal').style.display='none';
  $('createUserBtn').onclick = createUser; $('createFloorBtn').onclick = createFloor; $('createSpaceBtn').onclick = createSpace; $('saveSsoBtn').onclick = saveSsoSettings;
  $('createNewUserBtn').onclick = () => { closeUserEditor(); openUserEditor(false); };
  $('cancelUserEdit').onclick = () => closeUserEditor();
  $('resetUserPwBtn').onclick = async () => {
    if (!state.selectedUserEditId) return;
    if (!(await uiConfirm('Reset this user password?', 'Reset password'))) return;
    await resetPw(state.selectedUserEditId);
  };
  $('deleteUserBtn').onclick = async () => {
    if (!state.selectedUserEditId) return;
    await delUser(state.selectedUserEditId);
  };
  $('createNewFloorBtn').onclick = () => { closeFloorEditor(); openFloorEditor(false); };
  $('cancelFloorEdit').onclick = () => closeFloorEditor();
  $('deleteFloorBtn').onclick = async () => {
    if (!state.selectedFloorEditId) return;
    await delFloor(state.selectedFloorEditId);
  };
  $('createNewSpaceBtn').onclick = () => { closeSpaceEditor(); openSpaceEditor(false); };
  $('cancelSpaceEdit').onclick = () => closeSpaceEditor();
  $('deleteSpaceBtn').onclick = async () => {
    if (!state.selectedSpaceEditId) return;
    await delSpace(state.selectedSpaceEditId);
  };
  $('spaceFloorFilter').addEventListener('change', async () => { closeSpaceEditor(); await loadSpacesList(); });
  $('floorImageFile').addEventListener('change', async () => {
    const file = $('floorImageFile').files?.[0];
    if (!file) {
      if (state.selectedFloorEditId) {
        const f = state.floors.find(x => x.id === state.selectedFloorEditId);
        setFloorImagePreview(f?.image_path || '');
      } else {
        setFloorImagePreview('');
      }
      return;
    }
    const dataUrl = await fileToDataUrl(file);
    setFloorImagePreview(dataUrl);
  });

  $('saveBooking').onclick = saveBooking; $('cancelBooking').onclick = ()=> $('bookingModal').style.display='none';
  $('confirmRelease').onclick = releaseBooking;
  $('cancelRelease').onclick = ()=> $('releaseModal').style.display='none';
  $('clearFilters').onclick = ()=>{ $('onlyFree').checked=false; const d2=new Date(); d2.setMinutes(d2.getMinutes()-d2.getTimezoneOffset()); $('viewDate').value=d2.toISOString().slice(0,10); if(state.token) refreshFloorData().then(render); else render(); };
  $('floorSelect').addEventListener('change', async ()=>{ state.selectedSpot=null; await refreshFloorData(); render(); });
  ['viewDate','onlyFree'].forEach(id=>$(id).addEventListener('input', async ()=>{ if(state.token && (id==='viewDate')) await refreshFloorData(); render(); }));
  $('bookingSearch').addEventListener('input', () => { state.bookingPage = 1; renderTable(); });
  $('userSearch').addEventListener('input', () => renderUsersList());

  ['bookingModal','releaseModal'].forEach(id=>$(id).onclick=(e)=>{ if(e.target.id===id) $(id).style.display='none'; });
  $('bootstrapModal').onclick = () => {};
  $('loginModal').onclick = () => {};
  $('changePasswordModal').onclick = () => {};
  $('adminModal').onclick = () => {};
  $('messageModal').onclick = () => {};
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if ($('messageModal').style.display === 'flex') { e.preventDefault(); closeMessageModal(false); return; }
    if ($('bootstrapModal').style.display === 'flex' || $('loginModal').style.display === 'flex' || $('changePasswordModal').style.display === 'flex' || $('adminModal').style.display === 'flex') {
      e.preventDefault();
      return;
    }
    ['bookingModal'].forEach(id => {
      if ($(id).style.display === 'flex') $(id).style.display = 'none';
    });
  });

  (function dragMini(){
    const view = $('mapMiniView'); let drag=false,sx=0,sy=0,px=0,py=0;
    const down=(x,y)=>{drag=true;view.classList.add('dragging');sx=x;sy=y;px=state.panX;py=state.panY};
    const move=(x,y)=>{if(!drag)return;const r=view.getBoundingClientRect();state.panX=px-(x-sx)/r.width*100;state.panY=py-(y-sy)/r.height*100;updateMiniPos()};
    const up=()=>{drag=false;view.classList.remove('dragging')};
    const wheel=(e)=>{e.preventDefault(); updateMiniPos((state.miniZoom || 260) + (e.deltaY < 0 ? 20 : -20));};
    view.addEventListener('wheel', wheel, { passive:false });
    view.addEventListener('mousedown',e=>down(e.clientX,e.clientY)); window.addEventListener('mousemove',e=>move(e.clientX,e.clientY)); window.addEventListener('mouseup',up);
    view.addEventListener('touchstart',e=>{const t=e.touches[0];if(t)down(t.clientX,t.clientY)}); view.addEventListener('touchmove',e=>{const t=e.touches[0];if(t)move(t.clientX,t.clientY)}); window.addEventListener('touchend',up);
  })();

  (function dragSpaceMapEditor(){
    const view = $('spaceMapEditor'); let drag=false,sx=0,sy=0,px=0,py=0;
    const down=(x,y)=>{drag=true;view.classList.add('dragging');sx=x;sy=y;px=state.spaceMapX;py=state.spaceMapY};
    const move=(x,y)=>{if(!drag)return;const r=view.getBoundingClientRect();state.spaceMapX=px-(x-sx)/r.width*100;state.spaceMapY=py-(y-sy)/r.height*100;renderSpaceMapEditor();};
    const up=()=>{drag=false;view.classList.remove('dragging')};
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const onWheel = (e) => {
      e.preventDefault();
      const delta = e.deltaY < 0 ? 12 : -12;
      state.spaceMapZoom = clamp((state.spaceMapZoom || 260) + delta, 100, 500);
      renderSpaceMapEditor();
    };
    view.addEventListener('wheel', onWheel, { passive: false });
    view.addEventListener('mousedown',e=>down(e.clientX,e.clientY)); window.addEventListener('mousemove',e=>move(e.clientX,e.clientY)); window.addEventListener('mouseup',up);
    view.addEventListener('touchstart',e=>{const t=e.touches[0];if(t)down(t.clientX,t.clientY)}); view.addEventListener('touchmove',e=>{const t=e.touches[0];if(t)move(t.clientX,t.clientY)}); window.addEventListener('touchend',up);
  })();

  const qp = new URLSearchParams(window.location.search);
  const t = qp.get('token');
  const ssoErr = qp.get('sso_error');
  if (t) { state.token = t; window.history.replaceState({}, '', '/'); }
  if (ssoErr) { window.history.replaceState({}, '', '/'); uiAlert(`SSO login failed: ${ssoErr}`); }

  checkBootstrap();
  refreshAll().then(async () => {
    if (state.token && !state.me) {
      try {
        const me = await api('/api/me');
        state.me = me;
        setAuthUI();
        await refreshBookings();
        render();
      } catch { /* ignore */ }
    }
  }).catch(() => {});
})();
</script>
</body>
</html>
