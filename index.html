<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parking Booking Dashboard (Mock)</title>
  <style>
    :root {
      --bg: #0a0f1f;
      --panel: #101933;
      --border: #26365f;
      --text: #e7ecff;
      --muted: #94a5cf;
      --accent: #64d9ff;
      --accent-2: #7f82ff;
      --map-line: #e9f4ff;
      --map-arrow: #47f0d5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background: radial-gradient(1000px 500px at 18% -12%, #1a2b61 0%, var(--bg) 55%), var(--bg);
    }
    .app { max-width: 1320px; margin: 22px auto; padding: 0 16px; }
    .header, .panel {
      background: linear-gradient(180deg, #142145 0%, var(--panel) 100%);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .header {
      padding: 14px 18px; display: flex; justify-content: space-between; align-items: center;
      gap: 12px; margin-bottom: 14px;
    }
    .title { font-weight: 700; letter-spacing: .2px; }
    .muted { color: var(--muted); font-size: 13px; }
    .toolbar {
      margin-bottom: 14px; padding: 12px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
    }
    input, select, button {
      background: #0f1833; border: 1px solid #2b3a63; color: var(--text); border-radius: 10px;
      padding: 10px 12px; font-size: 14px;
    }
    button { cursor: pointer; }
    .btn-primary {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border: none; color: #041027; font-weight: 700;
    }
    .layout { display: grid; grid-template-columns: 2.1fr 1fr; gap: 14px; }
    .panel { padding: 14px; }
    .map-wrap {
      margin-top: 12px; border: 1px solid #30406a; border-radius: 12px; overflow: hidden; background: #111742;
    }
    svg { width: 100%; height: auto; display: block; }
    .lot-title { fill: #eef6ff; font-size: 46px; letter-spacing: 2px; font-weight: 300; opacity: .95; }
    .spot-rect {
      fill: rgba(5, 10, 70, .58); stroke: var(--map-line); stroke-width: 2; rx: 6; transition: .15s;
    }
    .spot-car { fill: none; stroke: rgba(230, 240, 255, .88); stroke-width: 2; opacity: .88; }
    .spot-label { fill: #d8e8ff; font-size: 15px; font-weight: 800; letter-spacing: .3px; pointer-events: none; }
    .spot-group { cursor: pointer; }
    .spot-group.free .spot-rect { fill: rgba(45, 209, 125, .14); stroke: rgba(124, 255, 189, .95); }
    .spot-group.booked .spot-rect { fill: rgba(255, 100, 128, .14); stroke: rgba(255, 155, 176, .95); }
    .spot-group.soon .spot-rect { fill: rgba(241, 186, 81, .14); stroke: rgba(255, 221, 150, .95); }
    .spot-group.selected .spot-rect { stroke: var(--accent); stroke-width: 3; }
    .chips { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .chip { font-size: 12px; padding: 5px 8px; border-radius: 999px; border: 1px solid #31426f; color: var(--muted); }
    .kv { margin-top: 10px; display: grid; gap: 8px; font-size: 14px; }
    .kv div b { color: #cfe0ff; }
    .map-mini {
      margin-top: 10px;
      border: 1px solid #2b3c66;
      border-radius: 10px;
      overflow: hidden;
      display: none;
    }
    .map-mini-view {
      position: relative;
      height: 340px;
      background-size: 260%;
      background-repeat: no-repeat;
      background-position: center;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
    .map-mini-view.dragging { cursor: grabbing; }
    .map-mini-dot {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 16px;
      height: 16px;
      margin-left: -8px;
      margin-top: -8px;
      border-radius: 50%;
      background: #ff3b3b;
      border: 2px solid #fff;
      box-shadow: 0 0 0 8px rgba(255, 59, 59, 0.22);
    }
    .map-mini-caption {
      font-size: 12px;
      color: var(--muted);
      padding: 6px 8px;
      border-top: 1px solid #2b3c66;
      background: #0f1833;
    }
    .actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; font-size: 13px; }
    th, td { padding: 10px; border-bottom: 1px solid #22335f; text-align: left; }
    th { color: #b7c5eb; font-weight: 600; }
    .overlay {
      position: fixed; inset: 0; background: rgba(5, 8, 18, .7); display: none;
      align-items: center; justify-content: center; padding: 16px; z-index: 10;
    }
    .modal {
      width: 100%; max-width: 520px; background: #121b35; border: 1px solid #30406b; border-radius: 14px; padding: 16px;
    }
    .modal h3 { margin: 0 0 12px; }
    .row { display: grid; gap: 8px; margin-bottom: 10px; }
    .header-actions { display: flex; align-items: center; gap: 8px; }
    .current-user-pill {
      font-size: 12px;
      color: #cfe0ff;
      border: 1px solid #31426f;
      border-radius: 999px;
      padding: 6px 10px;
      background: #0f1833;
      white-space: nowrap;
    }
    @media (max-width: 1040px) { .layout { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">Parking Booking Dashboard <span class="muted">POC Mock</span></div>
        <div class="muted" id="floorStats">Floor 1 Â· 20 spaces</div>
      </div>
      <div class="header-actions">
        <button id="openLoginPanel">Login</button>
        <span class="current-user-pill" id="currentUserLabel">User: Aidas</span>
        <div class="muted" id="clock"></div>
      </div>
    </div>

    <div class="panel toolbar">
      <select id="floorSelect">
        <option value="1">Floor 1 (20 spaces)</option>
        <option value="2">Floor 2 (10 spaces)</option>
      </select>
      <label class="muted"><input type="checkbox" id="isAdmin" /> Admin mode</label>
      <label class="muted"><input type="checkbox" id="onlyFree" /> Only free</label>
      <input id="search" placeholder="Search booked by user" />
      <button id="clearFilters">Clear filters</button>
    </div>

    <div class="layout">
      <div class="panel">
        <div class="title">Floor Plan</div>
        <div class="muted">Click a parking slot directly on the map.</div>

        <div class="map-wrap">
          <svg viewBox="0 0 1240 720" id="lotMap" aria-label="Parking lot map">
            <defs>
              <linearGradient id="lotBg" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#2f33a8" />
                <stop offset="100%" stop-color="#0f1370" />
              </linearGradient>
            </defs>

            <rect x="0" y="0" width="1240" height="720" fill="url(#lotBg)"/>
            <line x1="0" y1="130" x2="1240" y2="130" stroke="var(--map-line)" stroke-width="2" opacity=".7"/>

            <text x="920" y="75" class="lot-title" id="lotTitleA">PARKING</text>
            <text x="920" y="120" class="lot-title" id="lotTitleB">FLOOR 1</text>


            <g id="spotLayer"></g>
            <line x1="0" y1="458" x2="1240" y2="458" stroke="var(--map-line)" stroke-width="2" opacity=".7"/>
          </svg>
        </div>

        <div class="chips">
          <span class="chip">ðŸŸ¢ Free</span>
          <span class="chip">ðŸ”´ Booked</span>
          <span class="chip">ðŸŸ¡ Ending within 12h</span>
        </div>
      </div>

      <div class="panel">
        <div class="title">Space Details</div>
        <div class="muted" id="spotHint">Select a spot from the map</div>
        <div class="kv" id="details"></div>
        <div class="map-mini" id="mapMini">
          <div class="map-mini-view" id="mapMiniView">
                      </div>
          <div class="map-mini-caption" id="mapMiniCaption"></div>
        </div>
        <div class="actions" id="actions"></div>
      </div>
    </div>

    <div class="panel" style="margin-top:14px;">
      <div class="title">Upcoming / Active Bookings (selected floor)</div>
      <table>
        <thead><tr><th>Spot</th><th>User</th><th>Start</th><th>End</th><th>Status</th></tr></thead>
        <tbody id="bookingRows"></tbody>
      </table>
    </div>
  </div>

  <div class="overlay" id="loginModal">
    <div class="modal">
      <h3>User login panel</h3>
      <div class="row">
        <label class="muted">User</label>
        <input id="loginUser" placeholder="Enter user" />
      </div>
      <div class="row">
        <label class="muted">Password</label>
        <input id="loginPassword" type="password" placeholder="Enter password" />
      </div>
      <div class="actions">
        <button class="btn-primary" id="loginConfirm">Log in</button>
        <button id="loginClose">Close</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="bookingModal">
    <div class="modal">
      <h3>Book spot <span id="modalSpot"></span></h3>
      <div class="row">
        <label class="muted">Booked by</label>
        <input id="bookedBy" />
      </div>
      <div class="row">
        <label class="muted">Start date/time</label>
        <input id="startAt" type="datetime-local" />
      </div>
      <div class="row">
        <label class="muted">Duration</label>
        <select id="durationDays">
          <option value="1">1 day</option><option value="2">2 days</option><option value="3">3 days</option>
          <option value="4">4 days</option><option value="5">5 days</option><option value="6">6 days</option><option value="7">7 days</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn-primary" id="saveBooking">Confirm booking</button>
        <button id="cancelBooking">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    function offsetH(h) { return new Date(Date.now() + h * 3600_000).toISOString(); }

    const floors = {
      '1': { name: 'Floor 1', spots: buildFloor1() },
      '2': { name: 'Floor 2', spots: buildFloor2() }
    };
    const floorMaps = {
      '1': 'https://i.ibb.co/RY9KTGm/parking-Outside.png',
      '2': 'https://i.ibb.co/GkBQhfP/parking-Minus-Two.png'
    };

    function toId(n) {
      return String(n).padStart(3, '0');
    }

    function buildFloor1() {
      const out = [];
      for (let i = 0; i < 13; i++) out.push({ id: toId(i), x: 18 + i * 93, y: 160, w: 70, h: 170, dir: 'down' });
      for (let i = 0; i < 7; i++) out.push({ id: toId(13 + i), x: 550 + i * 88, y: 485, w: 66, h: 165, dir: 'up' });
      return out;
    }

    function buildFloor2() {
      const out = [];
      for (let i = 0; i < 5; i++) out.push({ id: toId(20 + i), x: 170 + i * 95, y: 175, w: 72, h: 175, dir: 'down' });
      for (let i = 0; i < 5; i++) out.push({ id: toId(25 + i), x: 610 + i * 95, y: 470, w: 72, h: 175, dir: 'up' });
      return out;
    }

    const bookings = [
      { floor: '1', spotId: '003', user: 'Jonas', start: offsetH(-3), end: offsetH(36) },
      { floor: '1', spotId: '012', user: 'Milda', start: offsetH(1), end: offsetH(49) },
      { floor: '2', spotId: '021', user: 'Admin', start: offsetH(-2), end: offsetH(8) }
    ];

    let selectedSpot = null;
    let miniBaseX = 50;
    let miniBaseY = 50;
    let miniPanX = 0;
    let miniPanY = 0;
    let currentUser = 'Aidas';

    function currentFloor() { return document.getElementById('floorSelect').value; }
    function currentSpots() { return floors[currentFloor()].spots; }

    function nowTick() {
      document.getElementById('clock').textContent = new Date().toLocaleString();
      releaseExpired();
      render();
    }

    function releaseExpired() {
      const now = Date.now();
      for (let i = bookings.length - 1; i >= 0; i--) if (new Date(bookings[i].end).getTime() <= now) bookings.splice(i, 1);
    }

    function activeBookingFor(spotId, floor) {
      const now = Date.now();
      return bookings.find(b => b.floor === floor && b.spotId === spotId && new Date(b.start).getTime() <= now && new Date(b.end).getTime() > now)
          || bookings.find(b => b.floor === floor && b.spotId === spotId && new Date(b.end).getTime() > now);
    }

    function statusClass(b) {
      if (!b) return 'free';
      const hoursLeft = (new Date(b.end).getTime() - Date.now()) / 3600_000;
      return hoursLeft <= 12 ? 'soon' : 'booked';
    }

    function getFilteredIds() {
      const onlyFree = document.getElementById('onlyFree').checked;
      const search = document.getElementById('search').value.trim().toLowerCase();
      const floor = currentFloor();
      const ids = new Set();
      for (const s of currentSpots()) {
        const b = activeBookingFor(s.id, floor);
        if (onlyFree && b) continue;
        if (search && (!b || !b.user.toLowerCase().includes(search))) continue;
        ids.add(s.id);
      }
      return ids;
    }

    function render() {
      const floor = currentFloor();
      document.getElementById('lotTitleB').textContent = `FLOOR ${floor}`;
      document.getElementById('floorStats').textContent = `${floors[floor].name} Â· ${floors[floor].spots.length} spaces`;
      document.getElementById('currentUserLabel').textContent = `User: ${currentUser || 'Unknown'}`;
      renderMap();
      renderDetails();
      renderTable();
    }

    function renderMap() {
      const layer = document.getElementById('spotLayer');
      const visible = getFilteredIds();
      const floor = currentFloor();
      layer.innerHTML = '';

      for (const s of currentSpots()) {
        if (!visible.has(s.id)) continue;
        const b = activeBookingFor(s.id, floor);
        const state = statusClass(b);
        const g = createSvg('g', { class: `spot-group ${state} ${selectedSpot === s.id ? 'selected' : ''}` });

        const rect = createSvg('rect', { class: 'spot-rect', x: s.x, y: s.y, width: s.w, height: s.h, rx: 7 });
        const label = createSvg('text', {
          class: 'spot-label',
          x: s.x + s.w / 2,
          y: s.y + s.h / 2,
          'text-anchor': 'middle',
          'dominant-baseline': 'middle'
        });
        label.textContent = s.id;

        g.append(rect, label);
        g.addEventListener('click', () => { selectedSpot = s.id; render(); });
        layer.appendChild(g);
      }
    }

    function createSvg(tag, attrs = {}) {
      const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
      for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, v);
      return el;
    }

    function renderDetails() {
      const hint = document.getElementById('spotHint');
      const details = document.getElementById('details');
      const actions = document.getElementById('actions');
      const mapMini = document.getElementById('mapMini');
      const mapMiniView = document.getElementById('mapMiniView');
      const mapMiniCaption = document.getElementById('mapMiniCaption');
      details.innerHTML = ''; actions.innerHTML = '';
      mapMini.style.display = 'none';
      if (!selectedSpot) return;

      const floor = currentFloor();
      const spot = currentSpots().find(s => s.id === selectedSpot);
      if (!spot) {
        selectedSpot = null;
        hint.textContent = 'Select a spot from the map';
        return;
      }

      const b = activeBookingFor(selectedSpot, floor);
      hint.textContent = `${floors[floor].name} Â· Spot ${selectedSpot}`;

      const rows = [`<div><b>Status:</b> ${b ? 'BOOKED' : 'FREE'}</div>`];
      if (b) {
        rows.push(`<div><b>User:</b> ${b.user}</div>`);
        rows.push(`<div><b>Start:</b> ${new Date(b.start).toLocaleString()}</div>`);
        rows.push(`<div><b>End:</b> ${new Date(b.end).toLocaleString()}</div>`);
      }
      details.innerHTML = rows.join('');

      miniBaseX = ((spot.x + spot.w / 2) / 1240) * 100;
      miniBaseY = ((spot.y + spot.h / 2) / 720) * 100;
      miniPanX = 0;
      miniPanY = 0;
      mapMiniView.style.backgroundImage = `url(${floorMaps[floor]})`;
      updateMiniMapPosition();
      mapMiniCaption.textContent = `Selected place location on ${floors[floor].name} (drag to explore)`;
      mapMini.style.display = 'block';

      if (!b) {
        const bookBtn = document.createElement('button');
        bookBtn.textContent = 'Book this spot';
        bookBtn.className = 'btn-primary';
        bookBtn.onclick = openBookingModal;
        actions.appendChild(bookBtn);
      }

      if (b && canRelease(b)) {
        const releaseBtn = document.createElement('button');
        releaseBtn.textContent = 'Release';
        releaseBtn.onclick = () => {
          const idx = bookings.findIndex(x => x.floor === floor && x.spotId === selectedSpot && x.end === b.end);
          if (idx >= 0) bookings.splice(idx, 1);
          render();
        };
        actions.appendChild(releaseBtn);
      }
    }

    function updateMiniMapPosition() {
      const mapMiniView = document.getElementById('mapMiniView');
      const x = Math.max(0, Math.min(100, miniBaseX + miniPanX));
      const y = Math.max(0, Math.min(100, miniBaseY + miniPanY));
      mapMiniView.style.backgroundPosition = `${x}% ${y}%`;
    }

    function canRelease(b) {
      if (!b) return false;
      const me = currentUser.trim().toLowerCase();
      if (document.getElementById('isAdmin').checked) return true;
      return b.user.trim().toLowerCase() === me;
    }

    function renderTable() {
      const rows = document.getElementById('bookingRows');
      const floor = currentFloor();
      const sorted = bookings.filter(b => b.floor === floor).sort((a, b) => new Date(a.start) - new Date(b.start));
      rows.innerHTML = sorted.map(b => {
        const status = new Date(b.start).getTime() > Date.now() ? 'Upcoming' : 'Active';
        return `<tr><td>${b.spotId}</td><td>${b.user}</td><td>${new Date(b.start).toLocaleString()}</td><td>${new Date(b.end).toLocaleString()}</td><td>${status}</td></tr>`;
      }).join('') || `<tr><td colspan="5" class="muted">No bookings</td></tr>`;
    }

    function openLoginModal() {
      document.getElementById('loginModal').style.display = 'flex';
      document.getElementById('loginUser').value = currentUser;
      document.getElementById('loginPassword').value = '';
    }

    function closeLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
    }

    function registerLogin(name, password) {
      if (!name || !password) return;
      currentUser = name.trim();
      render();
    }

    function openBookingModal() {
      if (!selectedSpot) return;
      document.getElementById('bookingModal').style.display = 'flex';
      document.getElementById('modalSpot').textContent = selectedSpot;
      document.getElementById('bookedBy').value = currentUser || 'Unknown';
      const d = new Date(); d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      document.getElementById('startAt').value = d.toISOString().slice(0,16);
      document.getElementById('durationDays').value = '1';
    }

    function closeBookingModal() { document.getElementById('bookingModal').style.display = 'none'; }

    document.getElementById('saveBooking').onclick = () => {
      const floor = currentFloor();
      const user = document.getElementById('bookedBy').value.trim();
      const start = new Date(document.getElementById('startAt').value);
      const days = Number(document.getElementById('durationDays').value);
      if (!user || Number.isNaN(start.getTime()) || days < 1 || days > 7) return;
      if (activeBookingFor(selectedSpot, floor)) return alert('Spot is already booked');
      const end = new Date(start.getTime() + days * 24 * 3600_000);
      bookings.push({ floor, spotId: selectedSpot, user, start: start.toISOString(), end: end.toISOString() });
      closeBookingModal(); render();
    };

    document.getElementById('cancelBooking').onclick = closeBookingModal;
    document.getElementById('bookingModal').onclick = (e) => { if (e.target.id === 'bookingModal') closeBookingModal(); };

    document.getElementById('openLoginPanel').onclick = openLoginModal;
    document.getElementById('loginClose').onclick = closeLoginModal;
    document.getElementById('loginModal').onclick = (e) => { if (e.target.id === 'loginModal') closeLoginModal(); };
    document.getElementById('loginConfirm').onclick = () => {
      const name = document.getElementById('loginUser').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!name || !password) return;
      registerLogin(name, password);
      closeLoginModal();
    };

    const submitLoginOnEnter = (e) => {
      if (e.key !== 'Enter') return;
      const name = document.getElementById('loginUser').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!name || !password) return;
      registerLogin(name, password);
      closeLoginModal();
    };
    document.getElementById('loginUser').addEventListener('keydown', submitLoginOnEnter);
    document.getElementById('loginPassword').addEventListener('keydown', submitLoginOnEnter);

    document.getElementById('clearFilters').onclick = () => {
      document.getElementById('onlyFree').checked = false;
      document.getElementById('search').value = '';
      render();
    };

    document.getElementById('floorSelect').addEventListener('change', () => {
      selectedSpot = null;
      render();
    });

    ['onlyFree','search','isAdmin'].forEach(id => {
      document.getElementById(id).addEventListener('input', render);
      document.getElementById(id).addEventListener('change', render);
    });

    (function initMiniMapDrag() {
      const view = document.getElementById('mapMiniView');
      let dragging = false;
      let startX = 0;
      let startY = 0;
      let startPanX = 0;
      let startPanY = 0;

      const pointerDown = (clientX, clientY) => {
        dragging = true;
        view.classList.add('dragging');
        startX = clientX;
        startY = clientY;
        startPanX = miniPanX;
        startPanY = miniPanY;
      };

      const pointerMove = (clientX, clientY) => {
        if (!dragging) return;
        const rect = view.getBoundingClientRect();
        const dx = clientX - startX;
        const dy = clientY - startY;
        miniPanX = startPanX - (dx / rect.width) * 100;
        miniPanY = startPanY - (dy / rect.height) * 100;
        updateMiniMapPosition();
      };

      const pointerUp = () => {
        dragging = false;
        view.classList.remove('dragging');
      };

      view.addEventListener('mousedown', (e) => pointerDown(e.clientX, e.clientY));
      window.addEventListener('mousemove', (e) => pointerMove(e.clientX, e.clientY));
      window.addEventListener('mouseup', pointerUp);

      view.addEventListener('touchstart', (e) => {
        const t = e.touches[0];
        if (!t) return;
        pointerDown(t.clientX, t.clientY);
      }, { passive: true });

      view.addEventListener('touchmove', (e) => {
        const t = e.touches[0];
        if (!t) return;
        pointerMove(t.clientX, t.clientY);
      }, { passive: true });

      window.addEventListener('touchend', pointerUp, { passive: true });
    })();

    setInterval(nowTick, 30_000);
    nowTick();
  </script>
</body>
</html>